


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compuational Exercises &#8212; Microbial Genomics Lab Spring 2022  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/cloud.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

    
    
     
        <script src="_static/jquery.cookie.js"></script>
    

    
     
        <script src="_static/cloud.base.js"></script>
    

    
     
        <script src="_static/cloud.js"></script>
    

    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Week 6" href="Week6.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Week6.html" title="Week 6"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">Microbial Genomics Lab Spring 2022  documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">Compuational Exercises</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS overrides for cloud theme */

/* nicer titles and more space for info and warning logos */

div.admonition p.admonition-title {
    background: rgba(0, 0, 0, .05);
    margin: .5em -1em;
    margin-top: -.5em !important;
    padding: .5em .5em .5em 2.65em;
}

/* indent single paragraph */
div.admonition {
    text-indent: 20px;
}
/* don't indent multiple paragraphs */
div.admonition > p {
    text-indent: 0;
}
/* remove excessive padding */
div.admonition.inline-title p.admonition-title {
    padding-left: .2em;
}
</style>
<div class="section" id="compuational-exercises">
<h1>Compuational Exercises<a class="headerlink" href="#compuational-exercises" title="Permalink to this headline">¶</a></h1>
<div class="section" id="go-over-last-weeks-results">
<h2>Go over last week’s results<a class="headerlink" href="#go-over-last-weeks-results" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Metagenome assemblies</p></li>
<li><p>Binning results</p></li>
<li><p>CheckM results</p></li>
<li><p>RefineM results</p></li>
</ul>
</div>
<div class="section" id="identification-of-16s-rrna-genes-in-mags">
<h2>Identification of 16S rRNA genes in MAGs<a class="headerlink" href="#identification-of-16s-rrna-genes-in-mags" title="Permalink to this headline">¶</a></h2>
<p>Today, you will install a tool known as <code class="docutils literal notranslate"><span class="pre">barrnap</span></code> to predict ribosomal
RNA-coding regions in genomes. This tool is written by Torsten Seemann
from University of Melbourne in Australia. You can see more about how to
run the tool here: <a class="reference external" href="https://github.com/tseemann/barrnap">https://github.com/tseemann/barrnap</a></p>
<p>This tool is sensitive enough to be able to identify 16S, 23S, and 5S
rRNA genes in microbial genomes but also homologous genes found in
eukaryotes and organelles. First, make sure you are connected to
Cerberus and use <code class="docutils literal notranslate"><span class="pre">conda</span></code> to install barrnap.</p>
<p>To install, just type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda install barrnap
</pre></div>
</div>
<p>Now, you will navigate into the folder produced by Metabat2 binning work
from last week. For example, in my home, I changed directory to the
following: <code class="docutils literal notranslate"><span class="pre">/home/jsaw/exercises/spades_meta/binning/bins</span></code> where the
bins or metagenome-assembled genomes (MAGs) are located.</p>
<p>Create a folder named as <code class="docutils literal notranslate"><span class="pre">rRNA</span></code> to store results from the <code class="docutils literal notranslate"><span class="pre">barrnap</span></code>
program. Next, you will use the following example command(s) to run
<code class="docutils literal notranslate"><span class="pre">barrnap</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>barrnap --quiet --kingdom bac --reject <span class="m">0</span>.05 --outseq rRNA/bin.barrnap.fasta bin.fa &gt; rRNA/bin.barrnap
</pre></div>
</div>
<p>Make sure you notice the positions of parameters entered to run the
tool. The bin name is entered last before the output is redirected using
a “&gt;” to a file named “bin.barrnap”. This is a minimum example of how to
run the tool. You can explore what options are available by typing
<code class="docutils literal notranslate"><span class="pre">barrnap</span> <span class="pre">-h</span></code>. In this example, I have specified <code class="docutils literal notranslate"><span class="pre">--kingdom</span> <span class="pre">bac</span></code> to
indicate that I’m searching for 16S genes using bacterial HMM (Hidden
Markov Model) prebuilt into the tool. If you have an archaeal, you would
ideally indicate that you want to use archaeal HMM by typing
<code class="docutils literal notranslate"><span class="pre">--kingdom</span> <span class="pre">arc</span></code>. In practice, it is sensitive enough that it will also
pick up rRNA genes for both domains of life.</p>
<p>Because you have multiple MAGs, to automate the process, I usually type
it in a <code class="docutils literal notranslate"><span class="pre">bash</span></code> loop so that I don’t have to type the same command for
multiple MAGs. Here is an example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> j <span class="k">in</span> <span class="sb">`</span>ls *.fa <span class="p">|</span> sed <span class="s1">&#39;s/.fa//g&#39;</span><span class="sb">`</span><span class="p">;</span><span class="k">do</span>
    barrnap --quiet --kingdom bac --reject <span class="m">0</span>.05 --outseq rRNA/<span class="si">${</span><span class="nv">j</span><span class="si">}</span>.barrnap.fasta <span class="si">${</span><span class="nv">j</span><span class="si">}</span>.fa &gt; rRNA/<span class="si">${</span><span class="nv">j</span><span class="si">}</span>.barrnap
<span class="k">done</span>
</pre></div>
</div>
<p>The first line is to look for all the files with extension “.fa” and
removing the extensions in the screen output so that just the base names
are left. Then to run the <code class="docutils literal notranslate"><span class="pre">barrnap</span></code> command on these files. If you go
into the <code class="docutils literal notranslate"><span class="pre">rRNA</span></code> folder to look at the files produced, you will notice
that there are two output files for each MAG: one ends with “.barrnap”
extension and the other with “.barrnap.fasta”. The first one just shows
the coordinates of these genes within the contigs of the MAGs but the
second one extracted those sequences from those regions and put them
into a “fasta” file.</p>
<p><strong>Warning:</strong> Ideally, you should run this script as an sbatch script and
not run it within the login node. However, <code class="docutils literal notranslate"><span class="pre">barrnap</span></code> is quite fast and
it is probably ok for today to run it in the login node.</p>
<p>You will notice that only some of the bins have the 16S rRNA sequences
necessary for you to identify what they are. So, to extract the 16S
sequences from those bins, you will type something like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> rRNA
<span class="k">for</span> j <span class="k">in</span> <span class="sb">`</span>ls *.fasta <span class="p">|</span> sed <span class="s1">&#39;s/.barrnap.fasta//g&#39;</span><span class="sb">`</span><span class="p">;</span><span class="k">do</span>
    grep <span class="s2">&quot;16S&quot;</span> <span class="si">${</span><span class="nv">j</span><span class="si">}</span>.barrnap.fasta <span class="p">|</span> sed <span class="s1">&#39;s/&gt;//g&#39;</span> <span class="p">|</span> head -1 &gt; <span class="si">${</span><span class="nv">j</span><span class="si">}</span>.16S.list
    seqtk subseq <span class="si">${</span><span class="nv">j</span><span class="si">}</span>.barrnap.fasta <span class="si">${</span><span class="nv">j</span><span class="si">}</span>.16S.list &gt; <span class="si">${</span><span class="nv">j</span><span class="si">}</span>.16S.fasta
<span class="k">done</span>
</pre></div>
</div>
<p>This command extracted just the 16S sequence from those MAGs that have
them, and then put them into files with “.16S.fasta” file. If they
didn’t have the 16S gene, then you would have empty files. How do you
check for empty files in Unix?</p>
<p>Now, you are ready to run BLAST on these 16S sequences.</p>
</div>
<div class="section" id="running-blast-to-identify-the-mags-with-16s-genes">
<h2>Running BLAST to identify the MAGs with 16S genes<a class="headerlink" href="#running-blast-to-identify-the-mags-with-16s-genes" title="Permalink to this headline">¶</a></h2>
<p>Now, you will need to install <code class="docutils literal notranslate"><span class="pre">blast</span></code> on <code class="docutils literal notranslate"><span class="pre">cerberus</span></code>. Use <code class="docutils literal notranslate"><span class="pre">conda</span></code>
as it is the easiest way to install it. You may have used <code class="docutils literal notranslate"><span class="pre">BLAST</span></code>
through a web interface, such as on the NCBI BLAST website
(<a class="reference external" href="https://blast.ncbi.nlm.nih.gov/Blast.cgi">https://blast.ncbi.nlm.nih.gov/Blast.cgi</a>) but today, we will first
learn how to use command line <code class="docutils literal notranslate"><span class="pre">BLAST</span></code> tool. Install it by typing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda install blast
</pre></div>
</div>
<p>The latest version is 2.10.1 as of today. An example command to run a
remote <code class="docutils literal notranslate"><span class="pre">BLAST</span></code> within the terminal environment is shown below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blastn -query bin.10.16S.fasta -db nt -remote -out test.blastn
</pre></div>
</div>
<p>As of this morning, remote BLAST on <code class="docutils literal notranslate"><span class="pre">cerberus</span></code> is not working
correctly. I would suggest that you first download the bins and
resulting files from <code class="docutils literal notranslate"><span class="pre">barrnap</span></code> to your local drive, install <code class="docutils literal notranslate"><span class="pre">BLAST</span></code>
locally, then run it on your laptop.</p>
<p><strong>Update:</strong> Upon further inspection the problem stems from an earlier
version of BLAST being installed, which was 2.5. If you install the
latest version of BLAST by typing <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">BLAST=2.10.1</span></code>, then
it works perfectly fine.</p>
<p>You can also produce html files using the command line BLAST. The
command for that is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blastn -query bin.10.16S.fasta -db nt -remote -html -out test.blastn.html
</pre></div>
</div>
<p>Now, using the <code class="docutils literal notranslate"><span class="pre">bash</span></code> for-loop I have shown as an example for running
<code class="docutils literal notranslate"><span class="pre">barrnap</span></code>, run remote BLAST on all the 16S sequences identified by
<code class="docutils literal notranslate"><span class="pre">barrnap</span></code>. After this, inspect the results to see what you were able
to identify from these BLAST results. What are the organisms identified
from these BLAST searches?</p>
</div>
<div class="section" id="running-web-based-blast-searches">
<h2>Running Web-based BLAST searches<a class="headerlink" href="#running-web-based-blast-searches" title="Permalink to this headline">¶</a></h2>
<p>Next, you will use web-based databases to identify your organisms.
First, go to NCBI BLAST website
(<a class="reference external" href="https://blast.ncbi.nlm.nih.gov/Blast.cgi">https://blast.ncbi.nlm.nih.gov/Blast.cgi</a>) and click on “Nucleotide
BLAST”. Here, you can paste your 16S sequence(s) from the MAGs and run
the same tool and against a reference database. First, paste one of the
16S sequences of your MAGs into the text box provided to enter
sequences.</p>
<p>Note that in the drop-down menu for “Database”, you can choose which
database to search against specifically. For example, if you choose
“nr/nt” under “Standard databases”, it is a comprehensive database of
all nucleotide sequences in NCBI so it will be slower and longer to
search. You can also search against “rRNA/ITS databases” and it will run
a little bit quicker, since it’s only containing ribosomal RNA or
related sequences.</p>
<p>Another website you should try to classify your organisms is to search
against the Silva database (<a class="reference external" href="https://www.arb-silva.de/">https://www.arb-silva.de/</a>). This contains a
manually curated database of all the 16S and 23S rRNA gene sequences and
they are more quality-controlled than NCBI nr/nt database. And searching
against the Silva 16S (or otherwise known as SSU - Small Subunit rRNA)
database will give you a better estimate of what your unknown organism
might be. This is due to the fact that 16S sequences in NCBI are
saturated by non-curated sequences that are simply annotated as
“uncultured bacteria” or “uncultured archaea” without any attempt to
further classify them. This makes it incredibly difficult to simply
identify your organism (especially if it happens to be previously
unknown organism) through BLAST searches.</p>
<p>Click on “Search” and choose “Sequence Search”. Paste a 16S sequence
into the search box and run the tool. Compare your results from NCBI and
Silva searches. Which database gave you a better idea of the identities
of the MAGs you obtained from the binning work?</p>
</div>
<div class="section" id="install-gtdb-tk-on-cerberus">
<h2>Install GTDB-TK on Cerberus<a class="headerlink" href="#install-gtdb-tk-on-cerberus" title="Permalink to this headline">¶</a></h2>
<p>Genome Taxonomy Database Toolkit (GTDB-Tk) is a software toolkit that
will assign taxonomic classification to bacterial and archaeal genomes
based on the Genome Taxonomy Database (GTDB). You can actually search
for GTDB classification of different bacteria and archaea here:
<a class="reference external" href="https://gtdb.ecogenomic.org/">https://gtdb.ecogenomic.org/</a></p>
<p>They essentially developed a classification system of prokaryotes
(<em>Bacteria</em> and <em>Archaea</em>) by using genomic information. By utilizing
conserved single-copy marker genes in thousands of genomes, they were
able to assign a more objective classification system than if one were
using just the 16S rRNA gene sequence. Their classification system
created a bit of headache because they renamed quite a number of
organisms based on their system and some names became a bit more
confusing to people who are not familiar with the new ones. For example,
if you look for the phylum <em>Chloroflexi</em>, which is a name of a phylum in
NCBI taxonomic classification system, they have renamed it to
<em>Chloroflexota</em>.</p>
<p>It remains to be seen if more microbiologists will adapt to the new
names in the near future. You can read their papers describing the GTDB
here (<a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/30148503/">https://pubmed.ncbi.nlm.nih.gov/30148503/</a>) and the toolkit here
(<a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/31730192/">https://pubmed.ncbi.nlm.nih.gov/31730192/</a>).</p>
<p>To install, first go here to read the detailed installation
instructions:
<a class="reference external" href="https://ecogenomics.github.io/GTDBTk/installing/bioconda.html#installing-bioconda">https://ecogenomics.github.io/GTDBTk/installing/bioconda.html#installing-bioconda</a></p>
<p>You have already done <strong>step 1</strong>. For step 2, you need to create an
environment for <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code>. As shown in the page, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda create -n gtdbtk -c bioconda gtdbtk
</pre></div>
</div>
<p>This command will actually create a conda environment named <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code>
and also install it at the same time. Next, you will need to activate
this environment. Type <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">activate</span> <span class="pre">gtdbtk</span></code> to activate the
environment, then type <code class="docutils literal notranslate"><span class="pre">gtdbtk</span> <span class="pre">-h</span></code> to see if it is correctly
installed. It will complain that you don’t have a reference database set
up yet. Normally, you will need to download the data, which is quite
large (~27 GB compressed). Because of this large file size, I have
downloaded for the class and all you need to do is to reference this
database in your Miniconda installation.</p>
<p>First, make sure that you have this file on <code class="docutils literal notranslate"><span class="pre">cerberus</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">~/</span><span class="n">miniconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">gtdbtk</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">activate</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">gtdbtk</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Check by typing:
<code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">~/miniconda3/envs/gtdbtk/etc/conda/activate.d/gtdbtk.sh</span></code></p>
<p>If it is there, the terminal will print the full path to the file. If
not, it will say “File not found”. Essentially, I’m trying to make sure
that you have this file created during installation of <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code>
through <code class="docutils literal notranslate"><span class="pre">conda</span></code>. The actually path will depend on how you first
installed Miniconda on <code class="docutils literal notranslate"><span class="pre">cerberus</span></code>. If you followed default
installation paths, then it should be the same as shown here. Next, you
will type this command to replace the template “path” information stored
in the <code class="docutils literal notranslate"><span class="pre">gtdbtk.sh</span></code> file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;export GTDBTK_DATA_PATH=/groups/bisc4234/gtdb-tk_data/release95/&quot;</span> &gt; ~/miniconda3/envs/gtdbtk/etc/conda/activate.d/gtdbtk.sh
</pre></div>
</div>
<p>I have downloaded the GTDB latest release in the folder
<code class="docutils literal notranslate"><span class="pre">/groups/gtdb-tk_data/release95</span></code> and <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code> needs this reference
data in order to run it correctly. After typing this command, log out of
<code class="docutils literal notranslate"><span class="pre">cerberus</span></code> and log back in. Now, activate the <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code> environment
again and type <code class="docutils literal notranslate"><span class="pre">gtdbtk</span> <span class="pre">-h</span></code>. Now this tool should be running correctly.
However, <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code> may still fail to run properly on <code class="docutils literal notranslate"><span class="pre">cerberus</span></code> due
to high memory requirement of one of the dependent tools known as
<code class="docutils literal notranslate"><span class="pre">pplacer</span></code>. This usually happens when you specify to many CPUs to be
used when running <code class="docutils literal notranslate"><span class="pre">pplacer</span></code>. As of now, <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code> tool does not run
properly due to the computational nodes not having enough memory for the
<code class="docutils literal notranslate"><span class="pre">pplacer</span></code> component.</p>
</div>
<div class="section" id="test-run-gtdb-tk-on-cerberus">
<h2>Test run GTDB-TK on Cerberus<a class="headerlink" href="#test-run-gtdb-tk-on-cerberus" title="Permalink to this headline">¶</a></h2>
<p>Once <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code> is correctly installed, you can run this tool to
classify the metagenomic bins produced by Metabat2. First, if you are
checking the bins produced by Metabat2 on a metaSPAdes assembly, go into
the <code class="docutils literal notranslate"><span class="pre">binning</span></code> subfolder first. Then create a sbatch script similar to
the one shown below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH -o gtdb.%j.out</span>
<span class="c1">#SBATCH -e gtdb.%j.err</span>
<span class="c1">#SBATCH -p defq</span>
<span class="c1">#SBATCH -N 1</span>
<span class="c1">#SBATCH -D /home/jsaw/exercises/spades_meta/binning</span>
<span class="c1">#SBATCH -J GTDBTK</span>
<span class="c1">#SBATCH -t 4:00:00</span>

gtdbtk classify_wf --genome_dir bins/ --out_dir gtdb-tk_out --cpus <span class="m">24</span> -x fa
</pre></div>
</div>
<p>And submit a job to run <code class="docutils literal notranslate"><span class="pre">gtdbtk</span></code>. It is quite CPU and memory intensive
program so it will take quite a while to run. At the end of the run, it
will produce a folder named <code class="docutils literal notranslate"><span class="pre">gtdb-tk_out</span></code>. There, you will find
summary files listing the taxonomic classifications of the bins being
checked.</p>
</div>
<div class="section" id="web-based-gtdb-tk-on-kbase">
<h2>Web-based GTDB-TK on KBase<a class="headerlink" href="#web-based-gtdb-tk-on-kbase" title="Permalink to this headline">¶</a></h2>
<p>GTDB-Tk may or may not run properly on Cerberus. It is a very
memory-intensive tool that require a large amount of RAMs to run. If it
is not running or failing, you can run GTDB-Tk on a website known as
KBase, which is hosted by Joint Genome Institute (Department of Energy).</p>
<p>The Joint Genome Institute (JGI) hosts this web-based version of GTDB-Tk
on its website known as “KBase”. KBase has a suite of bioinformatic
tools that are designed to be user-friendly for users who have little or
no experience with the command line environment. The website is here:
<a class="reference external" href="https://www.kbase.us/">https://www.kbase.us/</a></p>
<p>You will first need to create an account (free) and log in. Once you’re
in, you can upload the MAGs produced by Metabat2 to it. To start,</p>
<ul class="simple">
<li><p>first create a “New Narrative” (see top right of the page).</p></li>
<li><p>Then click on the “Add Data” red button on the left. A panel will pop
up on the right.</p></li>
<li><p>Click on “Import”, then click on the box. Upload your bins/MAGs. It
will upload the bins onto “staging” area.</p></li>
<li><p>Next, expand the “Upload” menu on the lower left of the page and
click “Batch Import Assembly from Staging Area”. This app will allow
you to batch upload the bins to your narrative.</p></li>
<li><p>In the parameters box, type your user name after the “/” sign, then
choose from “Assembly type”, “Metagenome-assembled genome (MAG)”,
then give this dataset a name under the “Output Objects”. This can be
any name but it is needed for the batch upload to work. Then click on
“Run” green button.</p></li>
<li><p>The tool will import your bins to the “Data” section of the page.
After this is done, select from the “Apps”, “Microbial Communities”,
then choose “GTDB-Tk classify”. This will open an inferface to run
GTDB-Tk on Kbase.</p></li>
<li><p>Choose from “Assembly input”, the name of the dataset you just
provided earlier to upload the bins. And click on “Run” button. This
will run the GTDB-Tk tool to classify your MAGs and it could take a
few hours or so.</p></li>
<li><p>Observe the results after the run is completed to see the lineages
the tool was able to identify. You can also download the result as a
CSV file.</p></li>
</ul>
</div>
<div class="section" id="retrieve-related-sequences-to-construct-a-phylogeny">
<h2>Retrieve related sequences to construct a phylogeny<a class="headerlink" href="#retrieve-related-sequences-to-construct-a-phylogeny" title="Permalink to this headline">¶</a></h2>
<p>We will use the NCBI BLAST website to search and retrieve 16S rRNA
sequences that are related to your query of interest. The main page for
NCBI BLAST is located here: <a class="reference external" href="https://blast.ncbi.nlm.nih.gov/Blast.cgi">https://blast.ncbi.nlm.nih.gov/Blast.cgi</a></p>
<p>There are many flavors of BLAST, which stands for Basic Local Alignment
Search Tool and was designed to perform pairwise comparison of DNA or
amino acid sequences. The tool was first pubished in 1990 (see here:
<a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/2231712/">https://pubmed.ncbi.nlm.nih.gov/2231712/</a>)</p>
<p>You can use BLAST to identify any DNA or amino acid sequences. In order
for this to work, one must search a query sequence (in your case, the
16S rRNA gene sequence) against a database of either DNA or protein
sequences. These are massive databases that are impractical for you to
download locally and search them using the command line BLAST.
Therefore, NCBI databases are critical for biologist to identify and
characterize any sequencing data they product in their labs.</p>
<p>Scroll down to find this tool known as “MOLE-BLAST” near the bottom of
the page. This is a new feature implemented to help us classify 16S rRNA
sequences of unknown organisms (I recommend you watch this video to
learn more about how to use this tool:
<a class="reference external" href="https://www.youtube.com/watch?v=wBbh_1vXgsY">https://www.youtube.com/watch?v=wBbh_1vXgsY</a>). Those identified in your
MAGs would fit this description well. Click on the “MOLE-BLAST” icon and
it will bring up a web interface to enter your sequence.</p>
<p><strong>Steps:</strong></p>
<ul class="simple">
<li><p>Copy and paste a 16S rRNA gene sequence of one of the MAGs produced
by Metabat2 (from metaSPAdes assembly) in the text box under “Enter
Query Sequences”.</p></li>
<li><p>Click on the drop-down menu next to “Database” and select “16S
ribosomal RNA sequences (Bacteria and Archaea)”.</p></li>
<li><p>Click on the “+” sign next to “Advanced parameters”</p></li>
<li><p>Change the “Maximum target sequences” to 50</p></li>
<li><p>Change the “Number of database sequences” under “Multiple Alignment
Parameters” to 20</p></li>
<li><p>Click on “Show results in a new window” and click on “Align”</p></li>
</ul>
<p>It will take several minutes for this to finish. At the end of this run,
you will be shown a phylogenetic tree. It will display the closest
relatives of your query sequence and will show approximate distances of
it to nearest neighbor. You should be aware that this tree is build
using “Fast Minimum Evolution” method and not a robust method to build
an accurate phylogenetic tree. We will download the alignment
(containing your query sequence and the neighbors) from this website and
run the phylogenetic analysis using better tools.</p>
<p><strong>To download the alignment:</strong></p>
<ul class="simple">
<li><p>Click on “See alignment” link near the top of the page.</p></li>
<li><p>This will display the accession numbers of close neighbors and also
the query sequence</p></li>
<li><p>You can see the positions that are aligned and also unaligned
positions along the sequence length (shown as “-” and known as gaps)</p></li>
<li><p>Click on “Download” link near the top of the page and choose “Fasta
plus gaps” to download the multiple sequence alignment</p></li>
<li><p>Save it in your exercises folder on your laptop but make sure to
rename it so that you remember what it is (make sure there are <em>no</em>
spaces in your file name!)</p></li>
</ul>
<p>Now, we can begin to construct a simply phylogenetic tree using this
alignment as an input file. Note that because we chose 20 for “Number of
database sequences” under “Multiple Alignment Parameters”, you will have
21 sequences (including your query) in this alignment file.</p>
</div>
<div class="section" id="construct-a-simple-phylogenetic-tree">
<h2>Construct a simple phylogenetic tree<a class="headerlink" href="#construct-a-simple-phylogenetic-tree" title="Permalink to this headline">¶</a></h2>
<p>Now, using your terminal, install a few tools needed to align the
sequences, visualize alignments, trim them, and to infer phylogenetic
trees. Use conda to install the following tools:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">mafft</span>
<span class="o">-</span> <span class="n">trimal</span>
<span class="o">-</span> <span class="n">iqtree</span>
<span class="o">-</span> <span class="n">figtree</span>
</pre></div>
</div>
<p><strong>We will install and run these tools on your laptop computer.</strong></p>
<p>To view multiple sequence alignments (MSA), download and install this
tool known as “Seaview” which has multiple versions for different
operating systems. Download it here:
<a class="reference external" href="http://doua.prabi.fr/software/seaview">http://doua.prabi.fr/software/seaview</a></p>
<p><strong>Aligning sequences</strong></p>
<p>We will use <code class="docutils literal notranslate"><span class="pre">mafft</span></code> to align your sequences. It is a high-performance
tool that can utilize multiple CPUs to speed up the alignment process
and has been benchmarked to be one of the best performing tools. The
paper describing the tool can be found here:
<a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/12136088/">https://pubmed.ncbi.nlm.nih.gov/12136088/</a></p>
<p>Before aligning the sequences, we need to reformat the fasta headers so
that the final tree you build will contain the proper labels with names
of organisms included in the tree tips. To do that, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sed <span class="s1">&#39;s/[ ,.|]/_/g&#39;</span> sequences.fa &gt; tmp.fa
mv tmp.fa sequences.fa
</pre></div>
</div>
<p>These commands remove space and other characters that might interfere
with the tree viewing program. Next, to align the fasta file you just
downloaded from the MOLE-BLAST page, let’s say if it is named as
<code class="docutils literal notranslate"><span class="pre">sequences.fasta</span></code>, for example, type in your terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mafft --auto --reorder sequences.fa &gt; alignment.fa
</pre></div>
</div>
<p>Now, start the Seaview program and open the <code class="docutils literal notranslate"><span class="pre">alignment.fasta</span></code> file to
see what a MSA looks like. See if and where gaps appear in the
alignment. Seaview has built-in phylogenetic inference tools that can
build trees but we will use the tools we just installed using <code class="docutils literal notranslate"><span class="pre">conda</span></code>
first.</p>
<p><strong>Trimming aligned sequences</strong></p>
<p>Next step before you run a phylogenetic inference tool is to trim
phylogenetically uninformative regions in the alignment. For example,
when you inspect the alignment using Seaview, you’ll notice that there
are some regions with only gaps and perhaps one or two taxa may have a
base in that position. Since it does not provide any information for the
substitution models being used by the phylogenetic inference tool, it is
best to remove them. Again, this is a subjective thing and how much data
to trim really depends on a lot of things. The tool we will be using to
trim the alignment is known as trimAl and the paper describing the tool
is found here: <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/19505945/">https://pubmed.ncbi.nlm.nih.gov/19505945/</a></p>
<p>To trim your alignment, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>trimal -in alignment.fa -automated1 -out trimmed_alignment.fa
</pre></div>
</div>
<p>We used the <code class="docutils literal notranslate"><span class="pre">-automated1</span></code> option to tell <code class="docutils literal notranslate"><span class="pre">trimal</span></code> to automatically
check what to trim based on heuristics. You can also manually specify
gap thresholds by providing the <code class="docutils literal notranslate"><span class="pre">-gt</span></code> flag with fractions (eg: 0.5
means to trim away a position if more than 50% of the taxa have a gap
character at a given position). Now, use Seaview to check the alignment
again. Did you notice the difference between the original
<code class="docutils literal notranslate"><span class="pre">alignment.fa</span></code> file and <code class="docutils literal notranslate"><span class="pre">trimmed_alignment.fa</span></code> file?</p>
<p>Now, we can continue with a phylogenetic inference program to construct
a phylogenetic tree.</p>
<p><strong>IQ-Tree</strong></p>
<p>We will use the tool known as IQ-Tree to constuct a phylogenetic tree of
your query with best hits. IQ-Tree has become one of the most popular
tools to construct phylogenetic trees and to calculate statistics for
phylogenetic/phylogenomic related analyses. I personally prefer using it
than any other tools out there. A recent paper describing the tool can
be found here: <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/32011700/">https://pubmed.ncbi.nlm.nih.gov/32011700/</a></p>
<p><em>Model Test</em></p>
<p>Before running an actual tree, we will run a model test to identify the
best substitution model to use for DNA sequences. Type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>iqtree -m TESTONLY -s trimmed_alignment.fa -st DNA -pre model_test -nt <span class="m">4</span>
</pre></div>
</div>
<p>This will run a model test tool that is part of the IQ-Tree tool. If you
are curious to know what each of these parameters mean, type
<code class="docutils literal notranslate"><span class="pre">iqtree</span> <span class="pre">-h</span></code> to see all the options and detailed explanation of each
parameter. Once the model test is done, look at the log file produced by
<code class="docutils literal notranslate"><span class="pre">iqtree</span></code>. The quickest way to just parse the best fit model in the log
file is to type like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>grep <span class="s2">&quot;Best-fit&quot;</span> model_test.log
</pre></div>
</div>
<p>In my example, this is the output I see:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Best</span><span class="o">-</span><span class="n">fit</span> <span class="n">model</span><span class="p">:</span> <span class="n">GTR</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">G4</span> <span class="n">chosen</span> <span class="n">according</span> <span class="n">to</span> <span class="n">BIC</span>
</pre></div>
</div>
<p>So IQ-Tree has found the model <code class="docutils literal notranslate"><span class="pre">GTR+F+G4</span></code> as the best-fit model based
on Bayesian Information Criterion
(<a class="reference external" href="https://en.wikipedia.org/wiki/Bayesian_information_criterion">https://en.wikipedia.org/wiki/Bayesian_information_criterion</a>). So we
will use this model to run IQ-Tree.</p>
<p><em>IQ-Tree</em></p>
<p>To run IQ-Tree with the model chosen, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>iqtree -m GTR+F+G4 -s trimmed_alignment.fa -st DNA -nt <span class="m">4</span> -bb <span class="m">1000</span> -pre iqtree_bin
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-bb</span> <span class="pre">1000</span></code> is a parameter for ultrafast bootstrap processes needed
to calculate bootstrap support for the tree. A number of 1000 is a
recommended number. It should run quite quickly. Now you can view the
resulting phylogenetic tree using a tree viewing program.</p>
</div>
<div class="section" id="viewing-the-phylogenetic-tree">
<h2>Viewing the phylogenetic tree<a class="headerlink" href="#viewing-the-phylogenetic-tree" title="Permalink to this headline">¶</a></h2>
<p>We will use this tool known as FigTree to view the resulting
phylogenetic tree locally on your laptop. If you have not already
installed FigTree on your local computer, use <code class="docutils literal notranslate"><span class="pre">conda</span></code> to install it
first. Next download the results from IQ-Tree analysis to your laptop
using <code class="docutils literal notranslate"><span class="pre">rsync</span></code>.</p>
<p>Once the files are downloaded, you can type in your terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>figtree iqtree_bin.contree
</pre></div>
</div>
<p>This will open a graphical interface of FigTree and it will prompt you
to enter a label for support values. Type “bootstrap” in the box. You
will see your Query sequence label as one of the tips in this tree.
Expand the menu under “Trees” on the left and check “Root tree”, then
check “Midpoint”. We are now rooting the tree using mid-point rooting
method. Check the box “Order nodes”. Now the tree is a little bit easier
to view. You can export the tree in various formats (such as PDF, SVG,
PNG, etc). Go to “File” menu and you can see the export options.</p>
<p>From this phylogenetic tree, you should be able to see the closest
relative of your MAG. What is the closest relative of your MAG based on
this tree? Again, this depends a bit of how novel the 16S sequence of
your MAG is. If it has sequence identity below 80% to the best match, it
is not going to be very easy to identify/classify them.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="index.html" title="index">
          <img class="logo" src="_static/gm_pan.png" alt="Logo"/>
        </a></p><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Compuational Exercises</a><ul>
<li><a class="reference internal" href="#go-over-last-weeks-results">Go over last week’s results</a></li>
<li><a class="reference internal" href="#identification-of-16s-rrna-genes-in-mags">Identification of 16S rRNA genes in MAGs</a></li>
<li><a class="reference internal" href="#running-blast-to-identify-the-mags-with-16s-genes">Running BLAST to identify the MAGs with 16S genes</a></li>
<li><a class="reference internal" href="#running-web-based-blast-searches">Running Web-based BLAST searches</a></li>
<li><a class="reference internal" href="#install-gtdb-tk-on-cerberus">Install GTDB-TK on Cerberus</a></li>
<li><a class="reference internal" href="#test-run-gtdb-tk-on-cerberus">Test run GTDB-TK on Cerberus</a></li>
<li><a class="reference internal" href="#web-based-gtdb-tk-on-kbase">Web-based GTDB-TK on KBase</a></li>
<li><a class="reference internal" href="#retrieve-related-sequences-to-construct-a-phylogeny">Retrieve related sequences to construct a phylogeny</a></li>
<li><a class="reference internal" href="#construct-a-simple-phylogenetic-tree">Construct a simple phylogenetic tree</a></li>
<li><a class="reference internal" href="#viewing-the-phylogenetic-tree">Viewing the phylogenetic tree</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="Week6.html"
                          title="Previous page">&larr; Week 6</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/exercises_week6.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Week6.html" title="Week 6"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">Microbial Genomics Lab Spring 2022  documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">Compuational Exercises</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Jimmy Saw.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>